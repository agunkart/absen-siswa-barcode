<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Siswa QR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Library untuk membaca & menulis file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Library untuk mengubah HTML ke Gambar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Library untuk membuat PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Library untuk membuat file ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        #qr-reader video {
            width: 100% !important;
            height: auto !important;
            border-radius: 0.5rem;
        }
        #qr-reader-region {
            border: none !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-200">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm">
            <div class="flex justify-center mb-6">
                 <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M3 3h18v18H3zM9 9h6v6H9z"/><path d="M3 9h2M3 15h2M19 9h2M19 15h2M9 3v2M15 3v2M9 19v2M15 19v2"/></svg>
            </div>
            <h2 class="text-2xl font-bold text-center mb-2">Aplikasi Absensi Siswa QR Code</h2>
            <p class="text-center text-gray-500 mb-6">Silakan masuk untuk melanjutkan.</p>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block mb-1 font-medium">Username</label>
                    <input type="text" id="username" class="w-full p-2 border rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label for="password" class="block mb-1 font-medium">Password</label>
                    <input type="password" id="password" class="w-full p-2 border rounded-lg" required>
                </div>
                <p id="login-error" class="text-red-500 text-sm text-center mb-4 hidden"></p>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">Login</button>
            </form>
            <p class="text-center text-xs text-gray-400 mt-8">
                Pengembang: Agung Kurniawan, S.Pd.
            </p>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="app-screen" class="hidden">
        <!-- Main Container -->
        <div class="container mx-auto p-4 md:p-6 max-w-7xl">
            <!-- Header -->
            <header class="bg-white shadow-md rounded-xl p-4 mb-6 flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-3 mb-4 md:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M3 3h18v18H3zM9 9h6v6H9z"/><path d="M3 9h2M3 15h2M19 9h2M19 15h2M9 3v2M15 3v2M9 19v2M15 19v2"/></svg>
                    <h1 class="text-2xl font-bold text-gray-800">Absensi Siswa QR</h1>
                </div>
                <nav class="flex flex-wrap justify-center items-center gap-2">
                    <button onclick="showPage('dashboard')" class="nav-link bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition">Dashboard</button>
                    <button onclick="showPage('siswa')" class="nav-link bg-white text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-200 transition">Siswa</button>
                    <button onclick="showPage('scanner')" class="nav-link bg-white text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-200 transition">Pindai Absen</button>
                    <button onclick="showPage('laporan')" class="nav-link bg-white text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-200 transition">Laporan</button>
                    <button onclick="showPage('pengaturan')" class="nav-link bg-white text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-200 transition">Pengaturan</button>
                    <button onclick="handleLogout()" class="bg-red-500 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-red-600 transition ml-4">Logout</button>
                </nav>
            </header>

            <!-- Main Content -->
            <main>
                <!-- Dashboard Page -->
                <div id="dashboard" class="page active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-xl font-bold mb-2">Selamat Datang!</h2>
                            <h3 id="dashboard-nama-sekolah" class="text-lg text-indigo-600 font-semibold mb-4"></h3>
                            <p class="text-gray-600">Ini adalah aplikasi absensi siswa menggunakan Kode QR. Silakan kelola data siswa, lalu gunakan pemindai untuk mencatat kehadiran secara digital.</p>
                            <button onclick="showPage('siswa')" class="mt-4 bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700 transition-all">Mulai Kelola Siswa &rarr;</button>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <h3 class="text-3xl font-bold text-indigo-600" id="total-siswa-stat">0</h3>
                                <p class="text-gray-500">Total Siswa</p>
                            </div>
                            <div class="text-center">
                                <h3 class="text-3xl font-bold text-green-500" id="hadir-hari-ini-stat">0</h3>
                                <p class="text-gray-500">Hadir Hari Ini</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Siswa Page -->
                <div id="siswa" class="page">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                            <h2 class="text-xl font-bold">Manajemen Data Siswa</h2>
                            <div class="flex gap-2 flex-wrap">
                                <button id="download-all-qr-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">Unduh Semua QR (.zip)</button>
                                <button onclick="document.getElementById('file-upload').click()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">Upload Excel</button>
                                <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls">
                                <button onclick="openModal('addSiswaModal')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Tambah Siswa</button>
                            </div>
                        </div>
                        <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded-r-lg mb-4">
                            <p class="font-bold">Petunjuk Upload Excel</p>
                            <p class="text-sm">Pastikan file Excel Anda memiliki header: <strong>NIS</strong>, <strong>Nama</strong>, <strong>Kelas</strong>, dan <strong>JenisKelamin</strong> (isi dengan "Laki-laki" atau "Perempuan").</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="p-3">NIS</th>
                                        <th class="p-3">Nama</th>
                                        <th class="p-3">Kelas</th>
                                        <th class="p-3">Jenis Kelamin</th>
                                        <th class="p-3 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="siswa-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Scanner Page -->
                <div id="scanner" class="page">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h2 class="text-xl font-bold mb-4">Pindai Kode QR Siswa</h2>
                                <div class="flex flex-col sm:flex-row items-center gap-4 mb-4 bg-gray-50 p-3 rounded-lg">
                                    <select id="camera-select" class="w-full sm:w-auto flex-grow p-2 border rounded-lg"></select>
                                    <button id="start-scan-btn" class="w-full sm:w-auto bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Mulai Pindai</button>
                                    <button id="stop-scan-btn" class="w-full sm:w-auto bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600" disabled>Stop Pindai</button>
                                </div>
                                <div id="qr-reader" class="w-full"></div>
                                <div id="scanner-status" class="mt-4 text-center font-medium"></div>
                            </div>
                             <div class="bg-white p-6 rounded-xl shadow-md">
                                <h2 class="text-xl font-bold mb-4">Log Absensi Terakhir</h2>
                                <div id="scan-log" class="space-y-2 h-64 overflow-y-auto"></div>
                            </div>
                        </div>
                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md">
                             <h2 class="text-xl font-bold mb-4">Siswa Belum Absen Hari Ini</h2>
                             <div id="belum-absen-list" class="space-y-2 h-[34rem] overflow-y-auto">
                                 <!-- Daftar siswa belum absen akan muncul di sini -->
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Laporan Page -->
                <div id="laporan" class="page">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4">Laporan Kehadiran</h2>
                        <!-- Laporan Bulanan -->
                        <div class="mb-8 p-4 border rounded-lg">
                            <h3 class="text-lg font-semibold mb-3">Laporan Bulanan</h3>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label for="filter-bulan" class="font-medium block mb-1">Pilih Bulan & Tahun:</label>
                                        <input type="month" id="filter-bulan" class="w-full p-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label for="laporan-kota" class="font-medium block mb-1">Kota Laporan:</label>
                                        <input type="text" id="laporan-kota" class="w-full p-2 border rounded-lg" placeholder="Contoh: Jakarta">
                                    </div>
                                    <div>
                                        <label for="laporan-tanggal-cetak" class="font-medium block mb-1">Tanggal Cetak:</label>
                                        <input type="date" id="laporan-tanggal-cetak" class="w-full p-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label for="laporan-ukuran-kertas" class="font-medium block mb-1">Ukuran Kertas (PDF):</label>
                                        <select id="laporan-ukuran-kertas" class="w-full p-2 border rounded-lg">
                                            <option value="f4">F4 (21.5 x 33 cm)</option>
                                            <option value="a4">A4 (21 x 29.7 cm)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="font-medium block mb-2">Margin Kertas (mm) untuk PDF:</label>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div>
                                            <label for="laporan-margin-top" class="text-sm">Atas</label>
                                            <input type="number" id="laporan-margin-top" value="10" class="w-full p-2 border rounded-lg">
                                        </div>
                                        <div>
                                            <label for="laporan-margin-bottom" class="text-sm">Bawah</label>
                                            <input type="number" id="laporan-margin-bottom" value="10" class="w-full p-2 border rounded-lg">
                                        </div>
                                        <div>
                                            <label for="laporan-margin-left" class="text-sm">Kiri</label>
                                            <input type="number" id="laporan-margin-left" value="10" class="w-full p-2 border rounded-lg">
                                        </div>
                                        <div>
                                            <label for="laporan-margin-right" class="text-sm">Kanan</label>
                                            <input type="number" id="laporan-margin-right" value="10" class="w-full p-2 border rounded-lg">
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-4">
                                    <button id="export-xlsx" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition disabled:bg-gray-400 w-full" disabled>
                                        Unduh XLSX
                                    </button>
                                    <button id="export-pdf" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition disabled:bg-gray-400 w-full" disabled>
                                        Unduh PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pengaturan Hari Libur Manual -->
                        <div class="mb-8 p-4 border rounded-lg">
                            <h3 class="text-lg font-semibold mb-3">Pengaturan Hari Libur Manual</h3>
                            <p class="text-sm text-gray-500 mb-4">Klik pada tanggal di kalender di bawah untuk menandainya sebagai hari libur tambahan atau menghapusnya. Hari Minggu dan libur nasional (warna merah) tidak dapat diubah.</p>
                            <div id="holiday-calendar-container">
                                <!-- Kalender akan dirender di sini -->
                            </div>
                            <div class="flex justify-end mt-4">
                                <button onclick="saveManualHolidays()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">Simpan Hari Libur</button>
                            </div>
                        </div>

                        <!-- Input Manual Harian -->
                        <div class="p-4 border rounded-lg">
                            <h3 class="text-lg font-semibold mb-3">Input Absensi Manual Harian</h3>
                            <div class="flex items-center bg-gray-50 p-4 rounded-lg mb-4">
                                <label for="manual-date" class="font-medium">Pilih Tanggal:</label>
                                <input type="date" id="manual-date" class="ml-2 p-2 border rounded-lg">
                            </div>
                            <div id="manual-attendance-list" class="space-y-2">
                                <!-- Daftar siswa untuk input manual akan muncul di sini -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pengaturan Page -->
                <div id="pengaturan" class="page">
                    <div class="bg-white p-6 rounded-xl shadow-md max-w-2xl mx-auto">
                        <h2 class="text-xl font-bold mb-6">Pengaturan Aplikasi</h2>
                        
                        <!-- Pengaturan Akun -->
                        <div class="mb-8 p-4 border rounded-lg">
                            <h3 class="text-lg font-semibold mb-3">Pengaturan Akun Login</h3>
                            <div class="mb-4">
                                <label for="setting-username" class="block mb-1 font-medium">Username</label>
                                <input type="text" id="setting-username" class="w-full p-2 border rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="setting-password" class="block mb-1 font-medium">Password Baru</label>
                                <input type="password" id="setting-password" class="w-full p-2 border rounded-lg" placeholder="Isi untuk mengubah atau mengatur password baru">
                            </div>
                        </div>

                        <!-- Pengaturan Data Sekolah -->
                        <div class="p-4 border rounded-lg">
                            <h3 class="text-lg font-semibold mb-3">Data Sekolah & Penanda Tangan</h3>
                            <div class="mb-4">
                                <label for="namaSekolah" class="block mb-1 font-medium">Nama Sekolah</label>
                                <input type="text" id="namaSekolah" class="w-full p-2 border rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="alamatSekolah" class="block mb-1 font-medium">Alamat Sekolah</label>
                                <textarea id="alamatSekolah" rows="3" class="w-full p-2 border rounded-lg"></textarea>
                            </div>
                            <hr class="my-6">
                            <div class="mb-4">
                                <label for="namaKepsek" class="block mb-1 font-medium">Nama Kepala Sekolah</label>
                                <input type="text" id="namaKepsek" class="w-full p-2 border rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="nipKepsek" class="block mb-1 font-medium">NIP Kepala Sekolah</label>
                                <input type="text" id="nipKepsek" class="w-full p-2 border rounded-lg">
                            </div>
                            <hr class="my-6">
                            <div class="mb-4">
                                <label for="namaWali" class="block mb-1 font-medium">Nama Wali Kelas / Guru</label>
                                <input type="text" id="namaWali" class="w-full p-2 border rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="nipWali" class="block mb-1 font-medium">NIP Wali Kelas / Guru</label>
                                <input type="text" id="nipWali" class="w-full p-2 border rounded-lg">
                            </div>
                        </div>
                        <div class="flex justify-end mt-6">
                            <button onclick="simpanPengaturan()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">Simpan Semua Pengaturan</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="addSiswaModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Tambah Siswa Baru</h3>
            <form id="addSiswaForm">
                <div class="mb-4">
                    <label for="nis" class="block mb-1 font-medium">Nomor Induk Siswa (NIS)</label>
                    <input type="text" id="nis" class="w-full p-2 border rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label for="nama" class="block mb-1 font-medium">Nama Lengkap</label>
                    <input type="text" id="nama" class="w-full p-2 border rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label for="kelas" class="block mb-1 font-medium">Kelas</label>
                    <input type="text" id="kelas" class="w-full p-2 border rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label for="jenisKelamin" class="block mb-1 font-medium">Jenis Kelamin</label>
                    <select id="jenisKelamin" class="w-full p-2 border rounded-lg" required>
                        <option value="Laki-laki">Laki-laki</option>
                        <option value="Perempuan">Perempuan</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeModal('addSiswaModal')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Batal</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Siswa Modal -->
    <div id="editSiswaModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Edit Data Siswa</h3>
            <form id="editSiswaForm">
                <input type="hidden" id="original-nis">
                <div class="mb-4">
                    <label for="edit-nis" class="block mb-1 font-medium">Nomor Induk Siswa (NIS)</label>
                    <input type="text" id="edit-nis" class="w-full p-2 border rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label for="edit-nama" class="block mb-1 font-medium">Nama Lengkap</label>
                    <input type="text" id="edit-nama" class="w-full p-2 border rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label for="edit-kelas" class="block mb-1 font-medium">Kelas</label>
                    <input type="text" id="edit-kelas" class="w-full p-2 border rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label for="edit-jenisKelamin" class="block mb-1 font-medium">Jenis Kelamin</label>
                    <select id="edit-jenisKelamin" class="w-full p-2 border rounded-lg" required>
                        <option value="Laki-laki">Laki-laki</option>
                        <option value="Perempuan">Perempuan</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeModal('editSiswaModal')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Batal</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="qrModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
            <div id="print-area" class="border p-4 rounded-lg bg-white">
                <h3 id="print-nama-sekolah" class="text-lg font-bold"></h3>
                <p id="print-alamat-sekolah" class="text-xs mb-4"></p>
                <hr class="my-2">
                <h4 id="qr-nama-siswa" class="text-xl font-bold mb-1"></h4>
                <p id="qr-nis-siswa" class="text-gray-600 mb-1"></p>
                <p id="qr-kelas-siswa" class="text-gray-600 mb-4"></p>
                <div id="qrcode-container" class="flex justify-center mb-6"></div>
                <p class="text-sm text-gray-500">Pindai kode ini untuk absensi</p>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button type="button" onclick="closeModal('qrModal')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Tutup</button>
                <button type="button" onclick="downloadQR()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Unduh JPEG</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
            <h3 class="text-lg font-bold mb-4">Konfirmasi Tindakan</h3>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400">Batal</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">Hapus</button>
            </div>
        </div>
    </div>

<script>
    // --- STATE MANAGEMENT ---
    let state = {
        siswa: [],
        absensi: [],
        pengaturan: {},
        manualHolidays: [] // Menyimpan tanggal libur manual
    };

    let html5QrCode;
    let confirmCallback = null;
    let manualChanges = {}; // Untuk menampung perubahan sebelum disimpan

    // --- UTILITY & HELPER FUNCTIONS ---
    const getTodayDateString = () => new Date().toISOString().split('T')[0];
    
    const publicHolidays = new Set([
        // 2024
        '2024-01-01', '2024-02-08', '2024-02-10', '2024-03-11', '2024-03-29', '2024-03-31', '2024-04-10', '2024-04-11', '2024-05-01', '2024-05-09', '2024-05-23', '2024-06-01', '2024-06-17', '2024-07-07', '2024-08-17', '2024-09-16', '2024-12-25',
        // 2025
        '2025-01-01', '2025-01-27', '2025-01-29', '2025-03-01', '2025-03-30', '2025-03-31', '2025-04-18', '2025-04-20', '2025-05-01', '2025-05-12', '2025-05-29', '2025-06-01', '2025-06-06', '2025-06-26', '2025-08-17', '2025-09-05', '2025-12-25',
        // 2026
        '2026-01-01', '2026-01-17', '2026-02-15', '2026-03-19', '2026-03-20', '2026-04-03', '2026-04-05', '2026-05-01', '2026-05-14', '2026-05-24', '2026-05-27', '2026-06-01', '2026-08-17', '2026-08-25', '2026-12-25'
    ]);

    const isDefaultHoliday = (date) => {
        const dateStr = date.toISOString().split('T')[0];
        return date.getDay() === 0 || publicHolidays.has(dateStr);
    };

    const isHoliday = (date) => {
        const dateStr = date.toISOString().split('T')[0];
        return isDefaultHoliday(date) || state.manualHolidays.includes(dateStr);
    };


    const loadState = () => {
        const savedSiswa = localStorage.getItem('absen_siswa_data');
        const savedAbsensi = localStorage.getItem('absen_absensi_data');
        const savedPengaturan = localStorage.getItem('absen_pengaturan_data');
        const savedManualHolidays = localStorage.getItem('absen_manual_holidays');
        if (savedSiswa) state.siswa = JSON.parse(savedSiswa);
        if (savedAbsensi) state.absensi = JSON.parse(savedAbsensi);
        if (savedPengaturan) state.pengaturan = JSON.parse(savedPengaturan);
        if (savedManualHolidays) state.manualHolidays = JSON.parse(savedManualHolidays);
    };

    const saveState = () => {
        localStorage.setItem('absen_siswa_data', JSON.stringify(state.siswa));
        localStorage.setItem('absen_absensi_data', JSON.stringify(state.absensi));
        localStorage.setItem('absen_pengaturan_data', JSON.stringify(state.pengaturan));
        localStorage.setItem('absen_manual_holidays', JSON.stringify(state.manualHolidays));
    };

    const playSound = (type) => {
        Tone.start();
        const synth = new Tone.Synth().toDestination();
        if (type === 'success') {
            synth.triggerAttackRelease("C5", "8n");
        } else if (type === 'error') {
            synth.triggerAttackRelease("C3", "8n", Tone.now());
            synth.triggerAttackRelease("C3", "8n", Tone.now() + 0.1);
        }
    }

    // --- PAGE NAVIGATION ---
    const showPage = (pageId) => {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');

        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('bg-indigo-600', 'text-white');
            link.classList.add('bg-white', 'text-gray-700');
        });
        const activeLink = document.querySelector(`.nav-link[onclick="showPage('${pageId}')"]`);
        if(activeLink) {
            activeLink.classList.add('bg-indigo-600', 'text-white');
            activeLink.classList.remove('bg-white', 'text-gray-700');
        }

        if (pageId === 'scanner') {
            initializeScannerPage();
        } else {
            stopScanner();
        }

        if (pageId === 'dashboard') updateDashboardStats();
        if (pageId === 'laporan') {
            document.getElementById('manual-date').value = getTodayDateString();
            document.getElementById('laporan-tanggal-cetak').value = getTodayDateString();
            renderManualAttendance();
            renderHolidayCalendar();
        }
        if (pageId === 'pengaturan') renderPengaturan();
    };

    // --- MODAL MANAGEMENT ---
    const openModal = (modalId) => document.getElementById(modalId).classList.remove('hidden');
    const closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');

    const showConfirm = (message, callback) => {
        document.getElementById('confirm-message').textContent = message;
        openModal('confirmModal');
        confirmCallback = callback;
    };

    // --- DASHBOARD ---
    const updateDashboardStats = () => {
        const totalSiswa = state.siswa.length;
        const today = getTodayDateString();
        const hadirHariIni = new Set(state.absensi.filter(absen => absen.tanggal === today && absen.status === 'H').map(a => a.nis)).size;

        document.getElementById('total-siswa-stat').textContent = totalSiswa;
        document.getElementById('hadir-hari-ini-stat').textContent = hadirHariIni;
        document.getElementById('dashboard-nama-sekolah').textContent = state.pengaturan.namaSekolah || 'Sekolah Belum Diatur';
    };

    // --- SISWA MANAGEMENT ---
    const renderSiswa = () => {
        const tableBody = document.getElementById('siswa-table-body');
        tableBody.innerHTML = '';
        if (state.siswa.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">Belum ada data siswa.</td></tr>`;
            return;
        }
        state.siswa.forEach(siswa => {
            const row = `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${siswa.nis}</td>
                    <td class="p-3 font-medium">${siswa.nama}</td>
                    <td class="p-3">${siswa.kelas}</td>
                    <td class="p-3">${siswa.jenisKelamin}</td>
                    <td class="p-3 text-center space-x-2">
                        <button onclick="showQrCode('${siswa.nis}')" class="text-indigo-600 hover:text-indigo-800 transition-colors">Lihat QR</button>
                        <button onclick="openEditModal('${siswa.nis}')" class="text-blue-600 hover:text-blue-800 transition-colors">Edit</button>
                        <button onclick="deleteSiswa('${siswa.nis}')" class="text-red-600 hover:text-red-800 transition-colors">Hapus</button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
        updateDashboardStats();
    };

    const addSiswa = (e) => {
        e.preventDefault();
        const nis = document.getElementById('nis').value.trim();
        const nama = document.getElementById('nama').value.trim();
        const kelas = document.getElementById('kelas').value.trim();
        const jenisKelamin = document.getElementById('jenisKelamin').value;

        if (state.siswa.find(s => s.nis === nis)) {
            alert('NIS sudah terdaftar!');
            return;
        }

        state.siswa.push({ nis, nama, kelas, jenisKelamin });
        saveState();
        renderSiswa();
        closeModal('addSiswaModal');
        document.getElementById('addSiswaForm').reset();
    };
    
    const openEditModal = (nis) => {
        const siswa = state.siswa.find(s => s.nis === nis);
        if (!siswa) return;

        document.getElementById('original-nis').value = siswa.nis;
        document.getElementById('edit-nis').value = siswa.nis;
        document.getElementById('edit-nama').value = siswa.nama;
        document.getElementById('edit-kelas').value = siswa.kelas;
        document.getElementById('edit-jenisKelamin').value = siswa.jenisKelamin;
        
        openModal('editSiswaModal');
    };

    const updateSiswa = (e) => {
        e.preventDefault();
        const originalNis = document.getElementById('original-nis').value;
        const newNis = document.getElementById('edit-nis').value.trim();
        const newNama = document.getElementById('edit-nama').value.trim();
        const newKelas = document.getElementById('edit-kelas').value.trim();
        const newJenisKelamin = document.getElementById('edit-jenisKelamin').value;

        if (newNis !== originalNis && state.siswa.find(s => s.nis === newNis)) {
            alert('NIS baru sudah terdaftar untuk siswa lain!');
            return;
        }

        const siswaIndex = state.siswa.findIndex(s => s.nis === originalNis);
        if (siswaIndex > -1) {
            state.siswa[siswaIndex] = { nis: newNis, nama: newNama, kelas: newKelas, jenisKelamin: newJenisKelamin };
            
            if (originalNis !== newNis) {
                state.absensi.forEach(absen => {
                    if (absen.nis === originalNis) {
                        absen.nis = newNis;
                        absen.nama = newNama;
                        absen.kelas = newKelas;
                    }
                });
            }

            saveState();
            renderSiswa();
            renderManualAttendance();
            closeModal('editSiswaModal');
        }
    };

    const deleteSiswa = (nis) => {
        showConfirm(`Apakah Anda yakin ingin menghapus siswa dengan NIS ${nis}? Data absensi siswa ini juga akan terhapus.`, () => {
            state.siswa = state.siswa.filter(s => s.nis !== nis);
            state.absensi = state.absensi.filter(a => a.nis !== nis);
            saveState();
            renderSiswa();
            renderManualAttendance();
        });
    };

    const handleFileUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet);

            let importedCount = 0;
            let skippedCount = 0;

            json.forEach(row => {
                const nis = row.NIS ? String(row.NIS).trim() : null;
                const nama = row.Nama ? String(row.Nama).trim() : null;
                const kelas = row.Kelas ? String(row.Kelas).trim() : null;
                const jenisKelamin = row.JenisKelamin ? String(row.JenisKelamin).trim() : null;

                if (nis && nama && kelas && jenisKelamin && !state.siswa.find(s => s.nis === nis)) {
                    state.siswa.push({ nis, nama, kelas, jenisKelamin });
                    importedCount++;
                } else {
                    skippedCount++;
                }
            });

            if (importedCount > 0) {
                saveState();
                renderSiswa();
            }
            alert(`Impor Selesai!\nBerhasil mengimpor: ${importedCount} siswa.\nDilewati (NIS duplikat/data tidak lengkap): ${skippedCount} siswa.`);
        };
        reader.readAsArrayBuffer(file);
        event.target.value = '';
    };

    // --- QR CODE ---
    const showQrCode = (nis) => {
        const siswa = state.siswa.find(s => s.nis === nis);
        if (!siswa) return;

        document.getElementById('print-nama-sekolah').textContent = state.pengaturan.namaSekolah || '';
        document.getElementById('print-alamat-sekolah').textContent = state.pengaturan.alamatSekolah || '';
        document.getElementById('qr-nama-siswa').textContent = siswa.nama;
        document.getElementById('qr-nis-siswa').textContent = `NIS: ${siswa.nis}`;
        document.getElementById('qr-kelas-siswa').textContent = `Kelas: ${siswa.kelas}`;

        const qrContainer = document.getElementById('qrcode-container');
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, {
            text: JSON.stringify({ nis: siswa.nis }),
            width: 200,
            height: 200,
        });

        openModal('qrModal');
    };
    
    const downloadQR = () => {
        const printArea = document.getElementById('print-area');
        const studentName = document.getElementById('qr-nama-siswa').textContent;
        const fileName = `kartu-qr-${studentName.replace(/\s+/g, '_')}.jpeg`;

        html2canvas(printArea, { scale: 2, useCORS: true }).then(canvas => {
            const link = document.createElement('a');
            link.download = fileName;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        });
    };

    const downloadAllQRsAsZip = async () => {
        const btn = document.getElementById('download-all-qr-btn');
        if (state.siswa.length === 0) {
            alert('Tidak ada data siswa untuk diunduh.');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Memproses...
        `;

        const zip = new JSZip();
        const tempContainer = document.createElement('div');
        tempContainer.style.position = 'absolute';
        tempContainer.style.left = '-9999px';
        tempContainer.style.width = '320px'; // Match modal width
        document.body.appendChild(tempContainer);

        for (const siswa of state.siswa) {
            // Create the card structure
            tempContainer.innerHTML = `
                <div id="temp-print-area" class="border p-4 rounded-lg bg-white text-center">
                    <h3 class="text-lg font-bold">${state.pengaturan.namaSekolah || ''}</h3>
                    <p class="text-xs mb-4">${state.pengaturan.alamatSekolah || ''}</p>
                    <hr class="my-2">
                    <h4 class="text-xl font-bold mb-1">${siswa.nama}</h4>
                    <p class="text-gray-600 mb-1">NIS: ${siswa.nis}</p>
                    <p class="text-gray-600 mb-4">Kelas: ${siswa.kelas}</p>
                    <div class="flex justify-center mb-6 qrcode-gen-container"></div>
                    <p class="text-sm text-gray-500">Pindai kode ini untuk absensi</p>
                </div>
            `;
            
            // Generate QR code inside the temp div
            const qrElement = tempContainer.querySelector('.qrcode-gen-container');
            new QRCode(qrElement, {
                text: JSON.stringify({ nis: siswa.nis }),
                width: 200,
                height: 200,
            });

            // Wait a bit for QR code to render before canvas capture
            await new Promise(resolve => setTimeout(resolve, 100)); 

            const canvas = await html2canvas(tempContainer.querySelector('#temp-print-area'), { scale: 2, useCORS: true });
            const imageData = canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
            
            const className = siswa.kelas.replace(/[^a-zA-Z0-9]/g, '_') || 'Tanpa_Kelas';
            const fileName = `${siswa.nama.replace(/[^a-zA-Z0-9]/g, '_')}_${siswa.nis}.jpeg`;
            
            zip.folder(className).file(fileName, imageData, { base64: true });
        }

        document.body.removeChild(tempContainer);

        zip.generateAsync({ type: "blob" }).then(function(content) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = "semua_qr_code_siswa.zip";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        btn.disabled = false;
        btn.textContent = 'Unduh Semua QR (.zip)';
    };

    // --- SCANNER ---
    const initializeScannerPage = () => {
        const cameraSelect = document.getElementById('camera-select');
        const startBtn = document.getElementById('start-scan-btn');
        const stopBtn = document.getElementById('stop-scan-btn');
        const scannerStatus = document.getElementById('scanner-status');

        html5QrCode = new Html5Qrcode("qr-reader");

        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                cameraSelect.innerHTML = '';
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.innerHTML = device.label;
                    cameraSelect.appendChild(option);
                });
            }
        }).catch(err => {
            scannerStatus.textContent = "Tidak dapat mengakses kamera.";
        });

        startBtn.addEventListener('click', () => {
            startScanner(cameraSelect.value);
        });

        stopBtn.addEventListener('click', () => {
            stopScanner();
        });
        
        renderBelumAbsenList();
    };

    const startScanner = (deviceId) => {
        const startBtn = document.getElementById('start-scan-btn');
        const stopBtn = document.getElementById('stop-scan-btn');
        const scannerStatus = document.getElementById('scanner-status');
        
        Tone.start(); // Initialize audio context on user interaction.

        stopScanner(); // Hentikan scanner jika sedang berjalan

        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            handleScan(decodedText);
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.pause();
                setTimeout(() => {
                    if (html5QrCode && html5QrCode.isScanning) {
                        html5QrCode.resume();
                    }
                }, 2000);
            }
        };

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        html5QrCode.start(deviceId, config, qrCodeSuccessCallback)
            .then(() => {
                startBtn.disabled = true;
                stopBtn.disabled = false;
                scannerStatus.textContent = "Arahkan kamera ke Kode QR";
                scannerStatus.className = "mt-4 text-center font-medium text-gray-600";
            })
            .catch(err => {
                scannerStatus.textContent = "Gagal memulai kamera. Pastikan Anda memberikan izin.";
                scannerStatus.className = "mt-4 text-center font-medium text-red-600";
            });
    };

    const stopScanner = () => {
        const startBtn = document.getElementById('start-scan-btn');
        const stopBtn = document.getElementById('stop-scan-btn');
        const scannerStatus = document.getElementById('scanner-status');

        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop()
                .then(() => {
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    scannerStatus.textContent = "Pindai dihentikan.";
                    scannerStatus.className = "mt-4 text-center font-medium text-gray-500";
                })
                .catch(err => console.error("Gagal menghentikan scanner.", err));
        } else {
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }
    };

    const handleScan = (qrData) => {
        const scannerStatus = document.getElementById('scanner-status');
        let nis;
        try {
            const data = JSON.parse(qrData);
            nis = data.nis;
            if(!nis) throw new Error("Format QR tidak valid.");
        } catch (e) {
            scannerStatus.textContent = `Error: Kode QR tidak valid.`;
            scannerStatus.className = 'mt-4 text-center font-bold text-red-500 p-3 bg-red-100 rounded-lg';
            addScanLog('Gagal', 'Kode QR tidak valid', 'error');
            playSound('error');
            return;
        }

        const siswa = state.siswa.find(s => s.nis === nis);
        if (!siswa) {
            scannerStatus.textContent = `Error: Siswa dengan NIS ${nis} tidak ditemukan.`;
            scannerStatus.className = 'mt-4 text-center font-bold text-red-500 p-3 bg-red-100 rounded-lg';
            addScanLog('Gagal', `Siswa NIS ${nis} tidak ada`, 'error');
            playSound('error');
            return;
        }

        const today = getTodayDateString();
        const sudahAbsen = state.absensi.find(absen => absen.nis === nis && absen.tanggal === today);

        if (sudahAbsen) {
            scannerStatus.textContent = `Info: ${siswa.nama} (${sudahAbsen.status}) sudah tercatat.`;
            scannerStatus.className = 'mt-4 text-center font-bold text-yellow-600 p-3 bg-yellow-100 rounded-lg';
            addScanLog('Info', `${siswa.nama} sudah absen`, 'info');
            playSound('error');
            return;
        }

        const now = new Date();
        const newAbsen = {
            id: Date.now(),
            nis: siswa.nis,
            nama: siswa.nama,
            kelas: siswa.kelas,
            tanggal: today,
            waktu: now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
            status: 'H' // H = Hadir
        };
        state.absensi.push(newAbsen);
        saveState();

        scannerStatus.textContent = `Berhasil: ${siswa.nama} (${siswa.kelas}) telah diabsen.`;
        scannerStatus.className = 'mt-4 text-center font-bold text-green-600 p-3 bg-green-100 rounded-lg';
        addScanLog('Berhasil', `${siswa.nama} (${siswa.kelas})`, 'success');
        playSound('success');
        updateDashboardStats();
        renderBelumAbsenList(); // Update the list of absent students
    };

    const addScanLog = (status, message, type) => {
        const logContainer = document.getElementById('scan-log');
        const time = new Date().toLocaleTimeString('id-ID');
        let colorClass = '';
        if (type === 'success') colorClass = 'text-green-600';
        if (type === 'error') colorClass = 'text-red-600';
        if (type === 'info') colorClass = 'text-yellow-600';

        const logEntry = `
            <div class="p-2 border-l-4 ${type === 'success' ? 'border-green-500' : type === 'error' ? 'border-red-500' : 'border-yellow-500'} bg-gray-50 rounded-r-lg">
                <p class="font-medium ${colorClass}">${status}: ${message}</p>
                <p class="text-xs text-gray-500">${time}</p>
            </div>
        `;
        logContainer.innerHTML = logEntry + logContainer.innerHTML;
    };
    
    const renderBelumAbsenList = () => {
        const listContainer = document.getElementById('belum-absen-list');
        const today = getTodayDateString();
        listContainer.innerHTML = '';

        const siswaAbsenHariIni = new Set(state.absensi.filter(a => a.tanggal === today).map(a => a.nis));
        const siswaBelumAbsen = state.siswa.filter(s => !siswaAbsenHariIni.has(s.nis));

        if (siswaBelumAbsen.length === 0) {
            listContainer.innerHTML = `<p class="text-gray-500 text-center p-4">Semua siswa sudah absen hari ini.</p>`;
            return;
        }

        siswaBelumAbsen.forEach(siswa => {
            const row = `
                <div class="flex justify-between items-center p-2 border-b">
                    <div>
                        <p class="font-medium text-sm">${siswa.nama}</p>
                        <p class="text-xs text-gray-500">${siswa.kelas}</p>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="markManualAttendanceFromScanner('${siswa.nis}', 'S')" class="bg-blue-500 text-white text-xs font-bold w-6 h-6 rounded-full hover:bg-blue-600">S</button>
                        <button onclick="markManualAttendanceFromScanner('${siswa.nis}', 'I')" class="bg-yellow-500 text-white text-xs font-bold w-6 h-6 rounded-full hover:bg-yellow-600">I</button>
                        <button onclick="markManualAttendanceFromScanner('${siswa.nis}', 'A')" class="bg-red-500 text-white text-xs font-bold w-6 h-6 rounded-full hover:bg-red-600">A</button>
                    </div>
                </div>
            `;
            listContainer.innerHTML += row;
        });
    };

    const markManualAttendanceFromScanner = (nis, status) => {
        const today = getTodayDateString();
        const siswa = state.siswa.find(s => s.nis === nis);
        
        const newAbsen = {
            id: Date.now(),
            nis: siswa.nis,
            nama: siswa.nama,
            kelas: siswa.kelas,
            tanggal: today,
            waktu: null, // Manual entry has no specific time
            status: status 
        };
        state.absensi.push(newAbsen);
        saveState();
        
        addScanLog('Manual', `${siswa.nama} ditandai ${status}`, 'info');
        renderBelumAbsenList(); // Re-render the list
    };


    // --- LAPORAN ---
    const renderManualAttendance = () => {
        const listContainer = document.getElementById('manual-attendance-list');
        const selectedDate = document.getElementById('manual-date').value;
        listContainer.innerHTML = '';
        manualChanges = {}; 

        if (!selectedDate) {
            listContainer.innerHTML = `<p class="text-gray-500">Pilih tanggal untuk menampilkan daftar siswa.</p>`;
            return;
        }

        let studentRowsHTML = '';
        state.siswa.forEach(siswa => {
            const attendanceRecord = state.absensi.find(a => a.nis === siswa.nis && a.tanggal === selectedDate);
            const currentStatus = attendanceRecord ? attendanceRecord.status : '';

            studentRowsHTML += `
                <div class="flex justify-between items-center p-3 border rounded-lg hover:bg-gray-50">
                    <div>
                        <p class="font-medium">${siswa.nama}</p>
                        <p class="text-sm text-gray-500">NIS: ${siswa.nis} | Kelas: ${siswa.kelas}</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <select data-nis="${siswa.nis}" class="p-2 border rounded-lg bg-white" onchange="handleManualChange(this)">
                            <option value="" ${currentStatus === '' ? 'selected' : ''}>-- Kosong --</option>
                            <option value="H" ${currentStatus === 'H' ? 'selected' : ''}>Hadir</option>
                            <option value="S" ${currentStatus === 'S' ? 'selected' : ''}>Sakit</option>
                            <option value="I" ${currentStatus === 'I' ? 'selected' : ''}>Izin</option>
                            <option value="A" ${currentStatus === 'A' ? 'selected' : ''}>Alfa</option>
                        </select>
                    </div>
                </div>
            `;
        });

        if (state.siswa.length > 0) {
            studentRowsHTML += `
                <div class="flex justify-end mt-4">
                    <button onclick="saveManualAttendance()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">Simpan Perubahan</button>
                </div>
            `;
        }

        listContainer.innerHTML = studentRowsHTML;
    };

    const handleManualChange = (selectElement) => {
        const nis = selectElement.dataset.nis;
        const status = selectElement.value;
        manualChanges[nis] = status;
    };

    const saveManualAttendance = () => {
        const selectedDate = document.getElementById('manual-date').value;
        if (!selectedDate) return;

        Object.keys(manualChanges).forEach(nis => {
            const newStatus = manualChanges[nis];
            const recordIndex = state.absensi.findIndex(a => a.nis === nis && a.tanggal === selectedDate);
            const siswa = state.siswa.find(s => s.nis === nis);

            if (newStatus === "") { 
                if (recordIndex > -1) {
                    state.absensi.splice(recordIndex, 1); 
                }
            } else { 
                if (recordIndex > -1) {
                    state.absensi[recordIndex].status = newStatus;
                    state.absensi[recordIndex].waktu = newStatus === 'H' ? new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : null;
                } else {
                    const newAbsen = {
                        id: Date.now(),
                        nis: nis,
                        nama: siswa.nama,
                        kelas: siswa.kelas,
                        tanggal: selectedDate,
                        waktu: newStatus === 'H' ? new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : null,
                        status: newStatus
                    };
                    state.absensi.push(newAbsen);
                }
            }
        });

        saveState();
        alert('Perubahan absensi berhasil disimpan!');
        manualChanges = {};
        renderManualAttendance();
        updateDashboardStats();
    };

    const renderHolidayCalendar = () => {
        const container = document.getElementById('holiday-calendar-container');
        const yearMonth = document.getElementById('filter-bulan').value;
        container.innerHTML = '';
        if (!yearMonth) {
            container.innerHTML = '<p class="text-gray-500 text-center">Pilih bulan dan tahun untuk mengatur hari libur.</p>';
            return;
        }

        const [year, month] = yearMonth.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();
        const firstDayOfMonth = new Date(year, month - 1, 1).getDay(); // 0=Sun, 1=Mon, ...
        const dayOffset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1; // Adjust to Mon-first week

        let calendarHTML = '<div class="grid grid-cols-7 gap-1 text-center">';
        const days = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
        days.forEach(day => {
            calendarHTML += `<div class="font-bold text-sm p-2">${day}</div>`;
        });

        for (let i = 0; i < dayOffset; i++) {
            calendarHTML += '<div></div>'; // Empty cells for offset
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(year, month - 1, day);
            const dateStr = currentDate.toISOString().split('T')[0];
            
            let classes = 'p-2 rounded-lg ';
            let isClickable = true;

            if (isDefaultHoliday(currentDate)) {
                classes += 'bg-red-100 text-red-700';
                isClickable = false;
            } else if (state.manualHolidays.includes(dateStr)) {
                classes += 'bg-yellow-300 cursor-pointer hover:bg-yellow-400';
            } else {
                classes += 'bg-white cursor-pointer hover:bg-gray-200';
            }

            calendarHTML += `<div class="${classes}" data-date="${dateStr}" ${isClickable ? `onclick="toggleManualHoliday(this)"` : ''}>${day}</div>`;
        }

        calendarHTML += '</div>';
        container.innerHTML = calendarHTML;
    };

    const toggleManualHoliday = (element) => {
        const dateStr = element.dataset.date;
        const index = state.manualHolidays.indexOf(dateStr);
        if (index > -1) {
            state.manualHolidays.splice(index, 1);
        } else {
            state.manualHolidays.push(dateStr);
        }
        renderHolidayCalendar(); // Re-render to show visual change immediately
    };

    const saveManualHolidays = () => {
        saveState();
        alert('Pengaturan hari libur berhasil disimpan!');
    };

    const generateMonthlyReportData = (yearMonth) => {
        const [year, month] = yearMonth.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();
        
        let headers = ['NIS', 'Nama', 'Kelas'];
        let effectiveDays = 0;
        for (let i = 1; i <= daysInMonth; i++) {
            headers.push(String(i));
            const currentDate = new Date(year, month - 1, i);
            if (!isHoliday(currentDate)) {
                effectiveDays++;
            }
        }
        headers.push('H', 'S', 'I', 'A', 'Ket.');

        const reportRows = state.siswa.map(siswa => {
            const row = {
                'NIS': siswa.nis, 'Nama': siswa.nama, 'Kelas': siswa.kelas,
            };
            let total = { H: 0, S: 0, I: 0, A: 0 };
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month - 1, day);
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                if (isHoliday(currentDate)) {
                    row[String(day)] = '';
                    continue;
                }

                const record = state.absensi.find(absen => absen.nis === siswa.nis && absen.tanggal === dateStr);
                const status = record ? record.status : 'A';
                row[String(day)] = status;
                
                if (record || status === 'A') { 
                   total[status] = (total[status] || 0) + 1;
                }
            }
            row['H'] = total.H;
            row['S'] = total.S;
            row['I'] = total.I;
            row['A'] = total.A;
            row['Ket.'] = effectiveDays > 0 ? `${((total.H / effectiveDays) * 100).toFixed(0)}%` : '0%';
            return row;
        });

        return { headers, reportRows };
    };

    const exportXLSX = () => {
        const yearMonth = document.getElementById('filter-bulan').value;
        if (!yearMonth) {
            alert("Silakan pilih bulan dan tahun terlebih dahulu.");
            return;
        }

        const { headers, reportRows } = generateMonthlyReportData(yearMonth);
        const monthName = new Date(yearMonth + '-02').toLocaleString('id-ID', { month: 'long', year: 'numeric' });
        const city = document.getElementById('laporan-kota').value || ".........................";
        const printDateValue = document.getElementById('laporan-tanggal-cetak').value;
        const printDate = printDateValue
            ? new Date(printDateValue + 'T00:00:00').toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})
            : new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});

        const worksheetData = [];
        worksheetData.push([state.pengaturan.namaSekolah || "Nama Sekolah"]);
        worksheetData.push([`Laporan Kehadiran Bulan ${monthName}`]);
        worksheetData.push([]);
        worksheetData.push(headers);
        reportRows.forEach(row => {
            worksheetData.push(Object.values(row));
        });

        worksheetData.push([], []);
        
        const signatureRow1 = [], signatureRow2 = [], signatureRow3 = [], signatureRow4 = [];
        signatureRow1[0] = 'Mengetahui,';
        signatureRow1[headers.length - 1] = `${city}, ${printDate}`;
        signatureRow2[0] = 'Kepala Sekolah,';
        signatureRow2[headers.length - 1] = 'Wali Kelas / Guru,';
        signatureRow3[0] = state.pengaturan.namaKepsek || '(.........................)';
        signatureRow3[headers.length - 1] = state.pengaturan.namaWali || '(.........................)';
        signatureRow4[0] = `NIP. ${state.pengaturan.nipKepsek || '.........................'}`;
        signatureRow4[headers.length - 1] = `NIP. ${state.pengaturan.nipWali || '.........................'}`;
        worksheetData.push(signatureRow1, signatureRow2, [], [], [], signatureRow3, signatureRow4);
        
        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan Absensi");
        const fileName = `laporan_absensi_${yearMonth}.xlsx`;
        XLSX.writeFile(workbook, fileName);
    };

    const exportPDF = () => {
        const yearMonth = document.getElementById('filter-bulan').value;
        if (!yearMonth) {
            alert("Silakan pilih bulan dan tahun terlebih dahulu.");
            return;
        }
        
        const paperSize = document.getElementById('laporan-ukuran-kertas').value;
        const format = paperSize === 'f4' ? [330, 215] : 'a4';

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: format });

        const { headers, reportRows } = generateMonthlyReportData(yearMonth);
        const monthName = new Date(yearMonth + '-02').toLocaleString('id-ID', { month: 'long', year: 'numeric' });
        
        const marginTop = parseFloat(document.getElementById('laporan-margin-top').value) || 10;
        const marginBottom = parseFloat(document.getElementById('laporan-margin-bottom').value) || 10;
        const marginLeft = parseFloat(document.getElementById('laporan-margin-left').value) || 10;
        const marginRight = parseFloat(document.getElementById('laporan-margin-right').value) || 10;

        doc.setFontSize(16);
        doc.text(state.pengaturan.namaSekolah || "Nama Sekolah", marginLeft, marginTop);
        doc.setFontSize(12);
        doc.text(`Laporan Kehadiran Bulanan: ${monthName}`, marginLeft, marginTop + 7);

        const tableBody = reportRows.map(row => headers.map(header => row[header]));

        doc.autoTable({
            head: [headers],
            body: tableBody,
            startY: marginTop + 15,
            margin: { top: marginTop, right: marginRight, bottom: marginBottom, left: marginLeft },
            theme: 'grid',
            headStyles: { fillColor: [22, 160, 133] },
            styles: { fontSize: 6, cellPadding: 1.5 },
            columnStyles: {
                0: {cellWidth: 20},
                1: {cellWidth: 40},
                2: {cellWidth: 20},
            },
            didDrawCell: function(data) {
                if (data.section === 'body' && data.column.index > 2 && data.column.index < headers.length - 5) {
                    let text = data.cell.text[0];
                    let fillColor;
                    switch(text) {
                        case 'S': fillColor = [209, 250, 229]; break;
                        case 'I': fillColor = [219, 234, 254]; break;
                        case 'A': fillColor = [254, 226, 226]; break;
                        case '': fillColor = [229, 231, 235]; break;
                        default: fillColor = null;
                    }

                    if (fillColor) {
                        doc.setFillColor(fillColor[0], fillColor[1], fillColor[2]);
                        doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                        doc.setTextColor(0, 0, 0);
                        const textX = data.cell.x + data.cell.width / 2;
                        const textY = data.cell.y + data.cell.height / 2;
                        doc.text(text, textX, textY, { halign: 'center', valign: 'middle' });
                    }
                }
            }
        });

        const finalY = doc.lastAutoTable.finalY + 10;
        const pageWidth = doc.internal.pageSize.getWidth();
        const city = document.getElementById('laporan-kota').value || ".........................";
        const printDateValue = document.getElementById('laporan-tanggal-cetak').value;
        const printDate = printDateValue
            ? new Date(printDateValue + 'T00:00:00').toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})
            : new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});

        doc.setFontSize(10);
        
        doc.text('Mengetahui,', marginLeft, finalY);
        doc.text('Kepala Sekolah', marginLeft, finalY + 5);
        doc.text(state.pengaturan.namaKepsek || '(.........................)', marginLeft, finalY + 25);
        doc.text(`NIP. ${state.pengaturan.nipKepsek || '.........................'}`, marginLeft, finalY + 30);

        doc.text(`${city}, ${printDate}`, pageWidth - marginRight, finalY, { align: 'right' });
        doc.text('Wali Kelas / Guru', pageWidth - marginRight, finalY + 5, { align: 'right' });
        doc.text(state.pengaturan.namaWali || '(.........................)', pageWidth - marginRight, finalY + 25, { align: 'right' });
        doc.text(`NIP. ${state.pengaturan.nipWali || '.........................'}`, pageWidth - marginRight, finalY + 30, { align: 'right' });

        const fileName = `laporan_absensi_${yearMonth}.pdf`;
        doc.save(fileName);
    };

    // --- PENGATURAN ---
    const renderPengaturan = () => {
        document.getElementById('namaSekolah').value = state.pengaturan.namaSekolah || '';
        document.getElementById('alamatSekolah').value = state.pengaturan.alamatSekolah || '';
        document.getElementById('namaKepsek').value = state.pengaturan.namaKepsek || '';
        document.getElementById('nipKepsek').value = state.pengaturan.nipKepsek || '';
        document.getElementById('namaWali').value = state.pengaturan.namaWali || '';
        document.getElementById('nipWali').value = state.pengaturan.nipWali || '';
        // Render data akun
        document.getElementById('setting-username').value = state.pengaturan.username || '';
    };

    const simpanPengaturan = () => {
        const newUsername = document.getElementById('setting-username').value.trim();
        const newPassword = document.getElementById('setting-password').value;

        if (!newUsername) {
            alert('Username tidak boleh kosong!');
            return;
        }

        state.pengaturan.username = newUsername;
        if (newPassword) {
            state.pengaturan.password = newPassword;
        }

        state.pengaturan.namaSekolah = document.getElementById('namaSekolah').value;
        state.pengaturan.alamatSekolah = document.getElementById('alamatSekolah').value;
        state.pengaturan.namaKepsek = document.getElementById('namaKepsek').value;
        state.pengaturan.nipKepsek = document.getElementById('nipKepsek').value;
        state.pengaturan.namaWali = document.getElementById('namaWali').value;
        state.pengaturan.nipWali = document.getElementById('nipWali').value;
        
        saveState();
        alert('Pengaturan berhasil disimpan!');
        updateDashboardStats();
        document.getElementById('setting-password').value = ''; // Kosongkan field password
    };
    
    // --- LOGIN & LOGOUT ---
    const handleLogin = (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const loginError = document.getElementById('login-error');

        if (username === state.pengaturan.username && password === state.pengaturan.password) {
            sessionStorage.setItem('isLoggedIn', 'true');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            initialize_app();
        } else {
            loginError.textContent = 'Username atau password salah.';
            loginError.classList.remove('hidden');
        }
    };

    const handleLogout = () => {
        sessionStorage.removeItem('isLoggedIn');
        window.location.reload();
    };


    // --- INITIALIZATION ---
    const initialize_app = () => {
        renderSiswa();
        renderPengaturan();
        updateDashboardStats();
        showPage('dashboard');

        document.getElementById('addSiswaForm').addEventListener('submit', addSiswa);
        document.getElementById('editSiswaForm').addEventListener('submit', updateSiswa);
        document.getElementById('file-upload').addEventListener('change', handleFileUpload);
        document.getElementById('download-all-qr-btn').addEventListener('click', downloadAllQRsAsZip);
        
        // Laporan listeners
        document.getElementById('export-xlsx').addEventListener('click', exportXLSX);
        document.getElementById('export-pdf').addEventListener('click', exportPDF);
        document.getElementById('filter-bulan').addEventListener('change', (e) => {
            const hasValue = !!e.target.value;
            document.getElementById('export-xlsx').disabled = !hasValue;
            document.getElementById('export-pdf').disabled = !hasValue;
            renderHolidayCalendar();
        });
        document.getElementById('manual-date').addEventListener('change', renderManualAttendance);

        document.getElementById('confirm-ok-btn').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            closeModal('confirmModal');
            confirmCallback = null;
        });

        document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
            closeModal('confirmModal');
            confirmCallback = null;
        });
    };
    
    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        document.getElementById('loginForm').addEventListener('submit', handleLogin);

        // Cek jika kredensial belum ada, atur default
        if (!state.pengaturan.username || !state.pengaturan.password) {
            state.pengaturan.username = 'admin';
            state.pengaturan.password = '12345';
            saveState();
        }

        const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';

        if (isLoggedIn) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            initialize_app();
        } else {
            // Selalu tampilkan layar login jika belum login
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    });
</script>

</body>
</html>
